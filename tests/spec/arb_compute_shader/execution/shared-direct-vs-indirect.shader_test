# Verify that a indirect SSBO store always invalidates
# all previous load/store

[require]
GL >= 3.3
ES >= 3.1
GLSL >= 3.30
GL_ARB_compute_shader
GL_ARB_shader_atomic_counters

[compute shader]
#version 330
#extension GL_ARB_compute_shader: enable
#extension GL_ARB_shader_atomic_counters: enable
#extension GL_ARB_shader_storage_buffer_object: enable

layout(local_size_x = 1, local_size_y = 1, local_size_z = 1) in;

layout(binding = 0) uniform atomic_uint counter;
shared uint vals[3];
uniform uint ref_val;
uniform uint offset;

void main()
{
  vals[1] = vals[2] = 0u;

  uint tmp = vals[1] + ref_val;
  vals[offset] = ref_val * 2u;
  uint tmp1 = vals[1];

  if (tmp == ref_val && tmp1 == ref_val * 2u)
    atomicCounterIncrement(counter);

  tmp = vals[2] + ref_val;
  atomicAdd(vals[offset + 1u], ref_val * 2u);
  tmp1 = vals[2];

  if (tmp == ref_val && tmp1 == ref_val * 2u)
    atomicCounterIncrement(counter);

}

[test]
atomic counters 1

uniform uint ref_val 5
uniform uint offset 1u

compute 1 1 1
probe atomic counter 0 == 2
